define(["durandal/system","durandal/app","durandal/activator","durandal/events","durandal/composition","plugins/history","knockout","jquery"],function(e,t,n,i,r,a,o,s){function c(e){return e=e.replace(m,"\\$&").replace(g,"(?:$1)?").replace(p,function(e,t){return t?e:"([^/]+)"}).replace(h,"(.*?)"),new RegExp("^"+e+"$")}function u(e){var t=e.indexOf(":"),n=t>0?t-1:e.length;return e.substring(0,n)}function l(e,t){return-1!==e.indexOf(t,e.length-t.length)}function d(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var n=0,i=e.length;i>n;n++)if(e[n]!=t[n])return!1;return!0}var f,v,g=/\((.*?)\)/g,p=/(\(\?)?:\w+/g,h=/\*\w+/g,m=/[\-{}\[\]+?.,\\\^$|#\s]/g,y=/\/$/,w=function(){function r(e){return e.router&&e.router.parent==M}function s(e){O&&O.config.isActive&&O.config.isActive(e)}function g(t,n){e.log("Navigation Complete",t,n);var i=e.getModuleId(V);i&&M.trigger("router:navigation:from:"+i),V=t,s(!1),O=n,s(!0);var a=e.getModuleId(V);a&&M.trigger("router:navigation:to:"+a),r(t)||M.updateDocumentTitle(t,n),v.explicitNavigation=!1,v.navigatingBack=!1,M.trigger("router:navigation:complete",t,n,M)}function p(t,n){e.log("Navigation Cancelled"),M.activeInstruction(O),O&&M.navigate(O.fragment,!1),T(!1),v.explicitNavigation=!1,v.navigatingBack=!1,M.trigger("router:navigation:cancelled",t,n,M)}function h(t){e.log("Navigation Redirecting"),T(!1),v.explicitNavigation=!1,v.navigatingBack=!1,M.navigate(t,{trigger:!0,replace:!0})}function m(t,n,i){v.navigatingBack=!v.explicitNavigation&&V!=i.fragment,M.trigger("router:route:activating",n,i,M),t.activateItem(n,i.params).then(function(e){if(e){var a=V;if(g(n,i),r(n)){var o=i.fragment;i.queryString&&(o+="?"+i.queryString),n.router.loadUrl(o)}a==n&&(M.attached(),M.compositionComplete())}else t.settings.lifecycleData&&t.settings.lifecycleData.redirect?h(t.settings.lifecycleData.redirect):p(n,i);f&&(f.resolve(),f=null)}).fail(function(t){e.error(t)})}function b(t,n,i){var r=M.guardRoute(n,i);r?r.then?r.then(function(r){r?e.isString(r)?h(r):m(t,n,i):p(n,i)}):e.isString(r)?h(r):m(t,n,i):p(n,i)}function x(e,t,n){M.guardRoute?b(e,t,n):m(e,t,n)}function I(e){return O&&O.config.moduleId==e.config.moduleId&&V&&(V.canReuseForRoute&&V.canReuseForRoute.apply(V,e.params)||!V.canReuseForRoute&&V.router&&V.router.loadUrl)}function _(){if(!T()){var t=N.shift();N=[],t&&(T(!0),M.activeInstruction(t),I(t)?x(n.create(),V,t):e.acquire(t.config.moduleId).then(function(n){var i=e.resolveObject(n);x(C,i,t)}).fail(function(n){e.error("Failed to load routed module ("+t.config.moduleId+"). Details: "+n.message)}))}}function S(e){N.unshift(e),_()}function k(e,t,n){for(var i=e.exec(t).slice(1),r=0;r<i.length;r++){var a=i[r];i[r]=a?decodeURIComponent(a):null}var o=M.parseQueryString(n);return o&&i.push(o),{params:i,queryParams:o}}function A(t){M.trigger("router:route:before-config",t,M),e.isRegExp(t)?t.routePattern=t.route:(t.title=t.title||M.convertRouteToTitle(t.route),t.moduleId=t.moduleId||M.convertRouteToModuleId(t.route),t.hash=t.hash||M.convertRouteToHash(t.route),t.routePattern=c(t.route)),t.isActive=t.isActive||o.observable(!1),M.trigger("router:route:after-config",t,M),M.routes.push(t),M.route(t.routePattern,function(e,n){var i=k(t.routePattern,e,n);S({fragment:e,queryString:n,config:t,params:i.params,queryParams:i.queryParams})})}function D(t){if(e.isArray(t.route))for(var n=t.isActive||o.observable(!1),i=0,r=t.route.length;r>i;i++){var a=e.extend({},t);a.route=t.route[i],a.isActive=n,i>0&&delete a.nav,A(a)}else A(t);return M}var V,O,N=[],T=o.observable(!1),C=n.create(),M={handlers:[],routes:[],navigationModel:o.observableArray([]),activeItem:C,isNavigating:o.computed(function(){var e=C(),t=T(),n=e&&e.router&&e.router!=M&&e.router.isNavigating()?!0:!1;return t||n}),activeInstruction:o.observable(null),__router__:!0};return i.includeIn(M),C.settings.areSameItem=function(e,t,n,i){return e==t?d(n,i):!1},M.parseQueryString=function(e){var t,n;if(!e)return null;if(n=e.split("&"),0==n.length)return null;t={};for(var i=0;i<n.length;i++){var r=n[i];if(""!==r){var a=r.split("=");t[a[0]]=a[1]&&decodeURIComponent(a[1].replace(/\+/g," "))}}return t},M.route=function(e,t){M.handlers.push({routePattern:e,callback:t})},M.loadUrl=function(t){var n=M.handlers,i=null,r=t,o=t.indexOf("?");if(-1!=o&&(r=t.substring(0,o),i=t.substr(o+1)),M.relativeToParentRouter){var s=this.parent.activeInstruction();r=s.params.join("/"),r&&"/"==r.charAt(0)&&(r=r.substr(1)),r||(r=""),r=r.replace("//","/").replace("//","/")}r=r.replace(y,"");for(var c=0;c<n.length;c++){var u=n[c];if(u.routePattern.test(r))return u.callback(r,i),!0}return e.log("Route Not Found"),M.trigger("router:route:not-found",t,M),O&&a.navigate(O.fragment,{trigger:!1,replace:!0}),v.explicitNavigation=!1,v.navigatingBack=!1,!1},M.updateDocumentTitle=function(e,n){n.config.title?document.title=t.title?n.config.title+" | "+t.title:n.config.title:t.title&&(document.title=t.title)},M.navigate=function(e,t){return e&&-1!=e.indexOf("://")?(window.location.href=e,!0):(v.explicitNavigation=!0,a.navigate(e,t))},M.navigateBack=function(){a.navigateBack()},M.attached=function(){M.trigger("router:navigation:attached",V,O,M)},M.compositionComplete=function(){T(!1),M.trigger("router:navigation:composition-complete",V,O,M),_()},M.convertRouteToHash=function(e){if(M.relativeToParentRouter){var t=M.parent.activeInstruction(),n=t.config.hash+"/"+e;return a._hasPushState&&(n="/"+n),n=n.replace("//","/").replace("//","/")}return a._hasPushState?e:"#"+e},M.convertRouteToModuleId=function(e){return u(e)},M.convertRouteToTitle=function(e){var t=u(e);return t.substring(0,1).toUpperCase()+t.substring(1)},M.map=function(t,n){if(e.isArray(t)){for(var i=0;i<t.length;i++)M.map(t[i]);return M}return e.isString(t)||e.isRegExp(t)?(n?e.isString(n)&&(n={moduleId:n}):n={},n.route=t):n=t,D(n)},M.buildNavigationModel=function(t){for(var n=[],i=M.routes,r=t||100,a=0;a<i.length;a++){var o=i[a];o.nav&&(e.isNumber(o.nav)||(o.nav=++r),n.push(o))}return n.sort(function(e,t){return e.nav-t.nav}),M.navigationModel(n),M},M.mapUnknownRoutes=function(t,n){var i="*catchall",r=c(i);return M.route(r,function(o,s){var c=k(r,o,s),u={fragment:o,queryString:s,config:{route:i,routePattern:r},params:c.params,queryParams:c.queryParams};if(t)if(e.isString(t))u.config.moduleId=t,n&&a.navigate(n,{trigger:!1,replace:!0});else if(e.isFunction(t)){var l=t(u);if(l&&l.then)return l.then(function(){M.trigger("router:route:before-config",u.config,M),M.trigger("router:route:after-config",u.config,M),S(u)}),void 0}else u.config=t,u.config.route=i,u.config.routePattern=r;else u.config.moduleId=o;M.trigger("router:route:before-config",u.config,M),M.trigger("router:route:after-config",u.config,M),S(u)}),M},M.reset=function(){return O=V=void 0,M.handlers=[],M.routes=[],M.off(),delete M.options,M},M.makeRelative=function(t){return e.isString(t)&&(t={moduleId:t,route:t}),t.moduleId&&!l(t.moduleId,"/")&&(t.moduleId+="/"),t.route&&!l(t.route,"/")&&(t.route+="/"),t.fromParent&&(M.relativeToParentRouter=!0),M.on("router:route:before-config").then(function(e){t.moduleId&&(e.moduleId=t.moduleId+e.moduleId),t.route&&(e.route=""===e.route?t.route.substring(0,t.route.length-1):t.route+e.route)}),M},M.createChildRouter=function(){var e=w();return e.parent=M,e},M};return v=w(),v.explicitNavigation=!1,v.navigatingBack=!1,v.targetIsThisWindow=function(e){var t=s(e.target).attr("target");return!t||t===window.name||"_self"===t||"top"===t&&window===window.top?!0:!1},v.activate=function(t){return e.defer(function(n){if(f=n,v.options=e.extend({routeHandler:v.loadUrl},v.options,t),a.activate(v.options),a._hasPushState)for(var i=v.routes,r=i.length;r--;){var o=i[r];o.hash=o.hash.replace("#","")}s(document).delegate("a","click",function(e){if(a._hasPushState){if(!e.altKey&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&v.targetIsThisWindow(e)){var t=s(this).attr("href");null==t||"#"===t.charAt(0)||/^[a-z]+:/i.test(t)||(v.explicitNavigation=!0,e.preventDefault(),a.navigate(t))}}else v.explicitNavigation=!0}),a.options.silent&&f&&(f.resolve(),f=null)}).promise()},v.deactivate=function(){a.deactivate()},v.install=function(){o.bindingHandlers.router={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,n,i,a){var s=o.utils.unwrapObservable(t())||{};if(s.__router__)s={model:s.activeItem(),attached:s.attached,compositionComplete:s.compositionComplete,activate:!1};else{var c=o.utils.unwrapObservable(s.router||i.router)||v;s.model=c.activeItem(),s.attached=c.attached,s.compositionComplete=c.compositionComplete,s.activate=!1}r.compose(e,s,a)}},o.virtualElements.allowedBindings.router=!0},v});